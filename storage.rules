rules_version = '2';

// Règles de sécurité Firebase Storage pour FLINCO
// Système de rapports de nettoyage avec liens uniques (sans authentification)
service firebase.storage {
  match /b/{bucket}/o {

    // ==================== PHOTOS ====================
    // Les agents uploadent des photos via un lien unique (pas d'auth)
    // Protection : taille max 10MB, formats images uniquement
    match /photos/{allPaths=**} {
      allow read: if true; // ✅ Lecture publique (pour liens courts et PDFs)
      allow write: if
        // Validation taille fichier (10 MB max)
        request.resource.size < 10 * 1024 * 1024
        // Validation type de fichier (images uniquement)
        && request.resource.contentType.matches('image/.*');
    }

    // ==================== VIDÉOS ====================
    // Vidéos des rapports de nettoyage
    // Protection : taille max 100MB, formats vidéo uniquement
    match /videos/{allPaths=**} {
      allow read: if true; // ✅ Lecture publique (pour liens courts)
      allow write: if
        // Validation taille fichier (100 MB max pour vidéos)
        request.resource.size < 100 * 1024 * 1024
        // Validation type de fichier (vidéos uniquement)
        && request.resource.contentType.matches('video/.*');
    }

    // ==================== RAPPORTS PDF ====================
    // PDFs générés à la fin des rapports
    // Protection : taille max 50MB, PDF uniquement
    match /reports/{allPaths=**} {
      allow read: if true; // ✅ Lecture publique (téléchargement depuis admin)
      allow write: if
        // Validation taille (50 MB max)
        request.resource.size < 50 * 1024 * 1024
        // Validation type PDF
        && request.resource.contentType == 'application/pdf';
    }

    // ==================== LOGOS ====================
    // Logos de l'entreprise (rarement modifiés)
    // Protection : lecture publique, écriture authentifiée uniquement
    match /logos/{allPaths=**} {
      allow read: if true; // ✅ Lecture publique
      allow write: if
        // Seulement si authentifié (admin)
        request.auth != null
        // Validation taille (5 MB max)
        && request.resource.size < 5 * 1024 * 1024
        // Validation type image
        && request.resource.contentType.matches('image/.*');
    }

    // ==================== DEVIS ====================
    // Fichiers devis uploadés par l'admin
    match /quotes/{allPaths=**} {
      allow read: if true; // ✅ Lecture publique
      allow write: if
        // Seulement si authentifié (admin)
        request.auth != null
        // Validation taille (10 MB max)
        && request.resource.size < 10 * 1024 * 1024
        // Validation type PDF
        && request.resource.contentType == 'application/pdf';
    }

    // ==================== DÉFAUT ====================
    // Par défaut : refuser tout le reste (sécurité)
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
